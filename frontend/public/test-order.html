<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Order Creation Test - Tweeky Queeky</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        border-bottom: 3px solid #007bff;
        padding-bottom: 10px;
      }
      .test-section {
        margin: 20px 0;
        padding: 20px;
        background: #f8f9fa;
        border-left: 4px solid #007bff;
      }
      .test-section h2 {
        margin-top: 0;
        color: #007bff;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 16px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      .success {
        color: #28a745;
        font-weight: bold;
      }
      .error {
        color: #dc3545;
        font-weight: bold;
      }
      .info {
        color: #17a2b8;
      }
      .log {
        background: #2d2d2d;
        color: #f8f8f8;
        padding: 15px;
        border-radius: 4px;
        max-height: 400px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        margin: 10px 0;
      }
      .log-entry {
        margin: 5px 0;
        padding: 5px;
        border-left: 3px solid #007bff;
        padding-left: 10px;
      }
      .log-entry.success {
        border-color: #28a745;
      }
      .log-entry.error {
        border-color: #dc3545;
      }
      .status-badge {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 14px;
        margin: 5px;
      }
      .status-badge.running {
        background: #ffc107;
        color: #000;
      }
      .status-badge.success {
        background: #28a745;
        color: white;
      }
      .status-badge.failed {
        background: #dc3545;
        color: white;
      }
      .data-display {
        background: #fff;
        border: 1px solid #dee2e6;
        padding: 15px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .data-display pre {
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üõí Tweeky Queeky - Order Creation E2E Test</h1>

      <div class="test-section">
        <h2>Test Controls</h2>
        <button onclick="runFullTest()">üöÄ Run Full E2E Test</button>
        <button onclick="runQuickOrderTest()">
          ‚ö° Quick Order Test (Skip Registration)
        </button>
        <button onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
        <button onclick="checkBackendHealth()">üè• Check Backend Health</button>
      </div>

      <div class="test-section">
        <h2>Test Status</h2>
        <div id="status">
          <span class="status-badge">Ready to test</span>
        </div>
      </div>

      <div class="test-section">
        <h2>Test Logs</h2>
        <div id="logs" class="log">
          <div class="log-entry">Waiting for tests to run...</div>
        </div>
      </div>

      <div class="test-section" id="data-section" style="display: none">
        <h2>Response Data</h2>
        <div id="data-display" class="data-display"></div>
      </div>
    </div>

    <script>
      const API_URL = 'http://localhost:5000/api';
      let testUser = {
        name: 'Test Buyer',
        email: `buyer${Date.now()}@example.com`,
        password: 'Test123!',
      };
      let productId = '';
      let orderId = '';

      function log(message, type = 'info') {
        const logs = document.getElementById('logs');
        const entry = document.createElement('div');
        entry.className = `log-entry ${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logs.appendChild(entry);
        logs.scrollTop = logs.scrollHeight;
      }

      function setStatus(message, type = 'running') {
        const status = document.getElementById('status');
        status.innerHTML = `<span class="status-badge ${type}">${message}</span>`;
      }

      function showData(title, data) {
        const section = document.getElementById('data-section');
        const display = document.getElementById('data-display');
        section.style.display = 'block';
        display.innerHTML = `<h3>${title}</h3><pre>${JSON.stringify(
          data,
          null,
          2
        )}</pre>`;
      }

      function clearLogs() {
        document.getElementById('logs').innerHTML =
          '<div class="log-entry">Logs cleared.</div>';
        document.getElementById('data-section').style.display = 'none';
      }

      async function checkBackendHealth() {
        log('Checking backend health...');
        try {
          const response = await fetch(`${API_URL}/health`);
          const data = await response.json();
          log(`‚úÖ Backend is ${data.status}`, 'success');
          showData('Health Check', data);
        } catch (error) {
          log(`‚ùå Backend health check failed: ${error.message}`, 'error');
        }
      }

      async function registerUser() {
        log(`Registering user: ${testUser.email}`);
        try {
          const response = await fetch(`${API_URL}/users`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(testUser),
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Registration failed');
          }

          const data = await response.json();
          log(`‚úÖ User registered: ${data.name} (${data._id})`, 'success');
          showData('Registration Response', data);
          return data;
        } catch (error) {
          log(`‚ùå Registration failed: ${error.message}`, 'error');
          throw error;
        }
      }

      async function loginUser() {
        log(`Logging in: ${testUser.email}`);
        try {
          const response = await fetch(`${API_URL}/users/auth`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              email: testUser.email,
              password: testUser.password,
            }),
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Login failed');
          }

          const data = await response.json();
          log(`‚úÖ Login successful: ${data.name}`, 'success');
          showData('Login Response', data);
          return data;
        } catch (error) {
          log(`‚ùå Login failed: ${error.message}`, 'error');
          throw error;
        }
      }

      async function getProducts() {
        log('Fetching products...');
        try {
          const response = await fetch(`${API_URL}/products`, {
            credentials: 'include',
          });

          if (!response.ok) {
            throw new Error('Failed to fetch products');
          }

          const data = await response.json();
          productId = data.products[0]._id;
          log(`‚úÖ Found ${data.products.length} products`, 'success');
          log(
            `Selected product: ${data.products[0].name} ($${data.products[0].price})`
          );
          return data;
        } catch (error) {
          log(`‚ùå Failed to fetch products: ${error.message}`, 'error');
          throw error;
        }
      }

      async function createOrder() {
        log('Creating order...');
        const orderData = {
          orderItems: [
            {
              name: 'Apple AirPods 4',
              qty: 1,
              image: '/images/airpods.jpg',
              price: 179.99,
              product: productId,
            },
          ],
          shippingAddress: {
            address: '123 Main St',
            city: 'New York',
            postalCode: '10001',
            country: 'United States',
          },
          paymentMethod: 'PayPal',
          itemsPrice: 179.99,
          taxPrice: 27.0,
          shippingPrice: 0.0,
          totalPrice: 206.99,
        };

        log('Order data prepared:');
        log(JSON.stringify(orderData, null, 2));

        try {
          const response = await fetch(`${API_URL}/orders`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(orderData),
          });

          if (!response.ok) {
            const error = await response.json();
            log(
              `‚ùå Server returned ${response.status}: ${JSON.stringify(error)}`,
              'error'
            );
            throw new Error(error.detail || `HTTP ${response.status}`);
          }

          const data = await response.json();
          orderId = data._id;
          log(`‚úÖ ORDER CREATED SUCCESSFULLY!`, 'success');
          log(`Order ID: ${data._id}`);
          log(`Total: $${data.totalPrice}`);
          log(`Payment Method: ${data.paymentMethod}`);
          showData('Order Created', data);
          return data;
        } catch (error) {
          log(`‚ùå Order creation failed: ${error.message}`, 'error');
          throw error;
        }
      }

      async function getOrder() {
        log(`Fetching order ${orderId}...`);
        try {
          const response = await fetch(`${API_URL}/orders/${orderId}`, {
            credentials: 'include',
          });

          if (!response.ok) {
            throw new Error('Failed to fetch order');
          }

          const data = await response.json();
          log(`‚úÖ Order retrieved successfully`, 'success');
          showData('Order Details', data);
          return data;
        } catch (error) {
          log(`‚ùå Failed to fetch order: ${error.message}`, 'error');
          throw error;
        }
      }

      async function runFullTest() {
        clearLogs();
        setStatus('Running Full E2E Test...', 'running');
        log('='.repeat(60));
        log('STARTING FULL E2E TEST');
        log('='.repeat(60));

        try {
          await checkBackendHealth();
          await registerUser();
          await loginUser();
          await getProducts();
          await createOrder();
          await getOrder();

          log('='.repeat(60));
          log('‚úÖ ALL TESTS PASSED!', 'success');
          log('='.repeat(60));
          setStatus('‚úÖ All Tests Passed', 'success');
        } catch (error) {
          log('='.repeat(60));
          log(`‚ùå TEST FAILED: ${error.message}`, 'error');
          log('='.repeat(60));
          setStatus('‚ùå Test Failed', 'failed');
        }
      }

      async function runQuickOrderTest() {
        clearLogs();
        setStatus('Running Quick Order Test...', 'running');
        log('='.repeat(60));
        log('QUICK ORDER TEST (Using existing session)');
        log('='.repeat(60));

        try {
          await checkBackendHealth();
          await getProducts();
          await createOrder();
          await getOrder();

          log('='.repeat(60));
          log('‚úÖ QUICK TEST PASSED!', 'success');
          log('='.repeat(60));
          setStatus('‚úÖ Quick Test Passed', 'success');
        } catch (error) {
          log('='.repeat(60));
          log(`‚ùå TEST FAILED: ${error.message}`, 'error');
          log('='.repeat(60));
          setStatus('‚ùå Test Failed', 'failed');
        }
      }

      // Auto-check on load
      window.addEventListener('load', () => {
        log('Test page loaded. Click "Run Full E2E Test" to begin.');
        checkBackendHealth();
      });
    </script>
  </body>
</html>
